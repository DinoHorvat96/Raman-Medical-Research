<!-- templates/new_patient.html -->
{% extends "base.html" %}

{% block title %}New Patient - Raman{% endblock %}

{% block content %}
<style>
    .section-divider {
        border-bottom: 2px solid #ecf0f1;
        padding-bottom: 30px;
        margin-bottom: 30px;
    }

    .section-title {
        color: #2c3e50;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ecf0f1;
    }

    .subsection {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 6px;
        margin-bottom: 20px;
        border-left: 4px solid #3498db;
    }

    .field-group {
        display: flex;
        gap: 15px;
        align-items: flex-start;
    }

    .field-group > * {
        flex: 1;
    }

    .conditional-field {
        display: none;
        margin-top: 15px;
        padding-left: 20px;
        border-left: 3px solid #95a5a6;
    }

    .conditional-field.active {
        display: block;
    }

    .add-more-btn {
        padding: 8px 16px;
        background: #27ae60;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        margin-top: 10px;
    }

    .add-more-btn:hover {
        background: #229954;
    }

    .remove-btn {
        padding: 6px 12px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }

    .remove-btn:hover {
        background: #c0392b;
    }

    .repeatable-item {
        background: white;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        position: relative;
    }

    .date-input-group {
        display: grid;
        grid-template-columns: 1fr 1fr 2fr;
        gap: 10px;
    }

    .form-help {
        font-size: 12px;
        color: #7f8c8d;
        margin-top: 5px;
    }

    .locs-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
    }

    select, input {
        font-size: 13px;
    }

    /* Patient ID Status Indicator */
    .patient-id-status {
        display: inline-block;
        margin-left: 10px;
        font-size: 13px;
        font-weight: 500;
    }

    .patient-id-status.checking {
        color: #95a5a6;
    }

    .patient-id-status.available {
        color: #27ae60;
    }

    .patient-id-status.unavailable {
        color: #e74c3c;
    }

    /* Notification System */
    .notification {
        position: fixed;
        top: 80px;
        right: 20px;
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-left: 4px solid #3498db;
        min-width: 300px;
        max-width: 400px;
        z-index: 9999;
        animation: slideIn 0.3s ease;
    }

    .notification.warning {
        border-left-color: #f39c12;
        background: #fff9e6;
    }

    .notification.error {
        border-left-color: #e74c3c;
        background: #ffe6e6;
    }

    .notification.success {
        border-left-color: #27ae60;
        background: #e6f7ee;
    }

    .notification .notification-title {
        font-weight: 600;
        margin-bottom: 5px;
        color: #2c3e50;
    }

    .notification .notification-message {
        font-size: 13px;
        color: #555;
    }

    .notification .notification-close {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        color: #95a5a6;
        font-size: 18px;
        line-height: 1;
    }

    .notification .notification-close:hover {
        color: #2c3e50;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
</style>

<!-- Notification Container -->
<div id="notification-container"></div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2>New Patient Entry</h2>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
    </div>

    <div class="info-box">
        <p><strong>Patient ID:</strong> The next available ID has been automatically assigned. You can change it if needed. The system will check availability in real-time.</p>
    </div>

    <form method="POST" action="{{ url_for('new_patient') }}" id="patientForm">

        <!-- ========== GENERAL DATA ========== -->
        <div class="section-divider">
            <h3 class="section-title">General Data</h3>

            <div class="form-row">
                <div class="form-group">
                    <label for="patient_id">Patient ID *</label>
                    <input type="number"
                           id="patient_id"
                           name="patient_id"
                           value="{{ next_patient_id }}"
                           min="1"
                           max="99999"
                           required>
                    <span id="id-status" class="patient-id-status"></span>
                    <small style="display:block; color: #7f8c8d; margin-top: 5px;">5 digits (00001-99999). Auto-assigned with real-time availability checking.</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="patient_name">Patient Name *</label>
                    <input type="text" id="patient_name" name="patient_name" required
                           placeholder="First Name Last Name">
                </div>

                <div class="form-group">
                    <label for="mbo">MBO (9 digits) *</label>
                    <input type="text" id="mbo" name="mbo" required
                           pattern="[0-9]{9}" maxlength="9"
                           placeholder="123456789">
                </div>

                <div class="form-group">
                    <label for="sex">Sex *</label>
                    <select id="sex" name="sex" required>
                        <option value="">Select...</option>
                        <option value="M">M</option>
                        <option value="F">F</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Date of Birth *</label>
                    <div class="date-input-group">
                        <input type="number" name="dob_day" placeholder="DD" min="1" max="31" required>
                        <input type="number" name="dob_month" placeholder="MM" min="1" max="12" required>
                        <input type="number" name="dob_year" placeholder="YYYY" min="1900" max="2100" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Date of Sample Collection *</label>
                    <div class="date-input-group">
                        <input type="number" name="collection_day" placeholder="DD" min="1" max="31" required>
                        <input type="number" name="collection_month" placeholder="MM" min="1" max="12" required>
                        <input type="number" name="collection_year" placeholder="YYYY" min="1900" max="2100" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="eye">Eye *</label>
                    <select id="eye" name="eye" required>
                        <option value="">Select...</option>
                        <option value="L">L</option>
                        <option value="R">R</option>
                        <option value="ND" selected>ND</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ========== MAIN OCULAR CONDITIONS ========== -->
        <div class="section-divider">
            <h3 class="section-title">Main Ocular Conditions</h3>

            <!-- Lens Status -->
            <div class="subsection">
                <div class="field-group">
                    <div class="form-group">
                        <label for="lens_status">Lens Status</label>
                        <select id="lens_status" name="lens_status" onchange="handleLensStatus(this.value)">
                            <option value="ND" selected>ND</option>
                            <option value="Phakic">Phakic</option>
                            <option value="Pseudophakic">Pseudophakic</option>
                            <option value="Aphakic">Aphakic</option>
                        </select>
                    </div>
                </div>

                <div id="locs_fields" class="conditional-field">
                    <label>LOCS III Grade (if Phakic)</label>
                    <div class="locs-grid">
                        <select name="locs_no">
                            <option value="ND" selected>NO-ND</option>
                            <option value="0.1">NO-0.1</option>
                            <option value="0.3">NO-0.3</option>
                            <option value="0.5">NO-0.5</option>
                            <option value="1.0">NO-1.0</option>
                            <option value="1.5">NO-1.5</option>
                            <option value="2.0">NO-2.0</option>
                            <option value="2.5">NO-2.5</option>
                            <option value="3.0">NO-3.0</option>
                            <option value="3.5">NO-3.5</option>
                            <option value="4.0">NO-4.0</option>
                            <option value="4.5">NO-4.5</option>
                            <option value="5.0">NO-5.0</option>
                            <option value="5.5">NO-5.5</option>
                            <option value="6.0">NO-6.0</option>
                            <option value="6.5">NO-6.5</option>
                            <option value="6.9">NO-6.9</option>
                        </select>
                        <select name="locs_nc">
                            <option value="ND" selected>NC-ND</option>
                            <option value="0.1">NC-0.1</option>
                            <option value="0.3">NC-0.3</option>
                            <option value="0.5">NC-0.5</option>
                            <option value="1.0">NC-1.0</option>
                            <option value="1.5">NC-1.5</option>
                            <option value="2.0">NC-2.0</option>
                            <option value="2.5">NC-2.5</option>
                            <option value="3.0">NC-3.0</option>
                            <option value="3.5">NC-3.5</option>
                            <option value="4.0">NC-4.0</option>
                            <option value="4.5">NC-4.5</option>
                            <option value="5.0">NC-5.0</option>
                            <option value="5.5">NC-5.5</option>
                            <option value="6.0">NC-6.0</option>
                            <option value="6.5">NC-6.5</option>
                            <option value="6.9">NC-6.9</option>
                        </select>
                        <select name="locs_c">
                            <option value="ND" selected>C-ND</option>
                            <option value="0.1">C-0.1</option>
                            <option value="0.3">C-0.3</option>
                            <option value="0.5">C-0.5</option>
                            <option value="1.0">C-1.0</option>
                            <option value="1.5">C-1.5</option>
                            <option value="2.0">C-2.0</option>
                            <option value="2.5">C-2.5</option>
                            <option value="3.0">C-3.0</option>
                            <option value="3.5">C-3.5</option>
                            <option value="4.0">C-4.0</option>
                            <option value="4.5">C-4.5</option>
                            <option value="5.0">C-5.0</option>
                            <option value="5.5">C-5.5</option>
                            <option value="5.9">C-5.9</option>
                        </select>
                        <select name="locs_p">
                            <option value="ND" selected>P-ND</option>
                            <option value="0.1">P-0.1</option>
                            <option value="0.3">P-0.3</option>
                            <option value="0.5">P-0.5</option>
                            <option value="1.0">P-1.0</option>
                            <option value="1.5">P-1.5</option>
                            <option value="2.0">P-2.0</option>
                            <option value="2.5">P-2.5</option>
                            <option value="3.0">P-3.0</option>
                            <option value="3.5">P-3.5</option>
                            <option value="4.0">P-4.0</option>
                            <option value="4.5">P-4.5</option>
                            <option value="5.0">P-5.0</option>
                            <option value="5.5">P-5.5</option>
                            <option value="5.9">P-5.9</option>
                        </select>
                    </div>
                </div>

                <div id="iol_fields" class="conditional-field">
                    <div class="form-group">
                        <label for="iol_type">IOL Type (if Pseudophakic)</label>
                        <select name="iol_type">
                            <option value="ND" selected>ND</option>
                            <option value="AC IOL">AC IOL (anterior chamber)</option>
                            <option value="IF IOL">IF IOL (iris-fixated)</option>
                            <option value="SF IOL">SF IOL (sclera-fixated)</option>
                            <option value="CS IOL">CS IOL (ciliary sulcus)</option>
                            <option value="PC IOL">PC IOL (posterior chamber in-the-bag)</option>
                            <option value="PIOL">PIOL (phakic IOL)</option>
                        </select>
                    </div>
                </div>

                <div id="aphakia_fields" class="conditional-field">
                    <div class="form-group">
                        <label for="aphakia_etiology">Etiology (if Aphakic)</label>
                        <select name="aphakia_etiology">
                            <option value="ND" selected>ND</option>
                            <option value="Congenital">Congenital</option>
                            <option value="Acquired">Acquired</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Glaucoma -->
            <div class="subsection">
                <div class="field-group">
                    <div class="form-group">
                        <label for="glaucoma">Glaucoma</label>
                        <select id="glaucoma" name="glaucoma" onchange="handleGlaucoma(this.value)">
                            <option value="0" selected>0</option>
                            <option value="1">1</option>
                            <option value="ND">ND</option>
                        </select>
                    </div>
                </div>

                <div id="oht_pac_fields" class="conditional-field">
                    <div class="form-group">
                        <label for="oht_or_pac">OHT or PAC (if Glaucoma = 0)</label>
                        <select name="oht_or_pac">
                            <option value="0">0</option>
                            <option value="OHT">OHT (Ocular Hypertension)</option>
                            <option value="PAC">PAC (Primary Angle Closure)</option>
                            <option value="ND" selected>ND</option>
                        </select>
                    </div>
                </div>

                <div id="glaucoma_etiology_fields" class="conditional-field">
                    <div class="form-group">
                        <label for="glaucoma_etiology">Etiology (if Glaucoma = 1)</label>
                        <select name="glaucoma_etiology">
                            <option value="ND" selected>ND</option>
                            <option value="POAG">POAG (primary open angle)</option>
                            <option value="NTG">NTG (normal tension)</option>
                            <option value="PCG">PCG (primary congenital)</option>
                            <option value="JOAG">JOAG (juvenile open angle)</option>
                            <option value="PACG">PACG (primary angle closure)</option>
                            <option value="PXG">PXG (pseudoexfoliation)</option>
                            <option value="PG">PG (pigmentary)</option>
                            <option value="NVG">NVG (neovascular)</option>
                            <option value="UG">UG (uveitic)</option>
                            <option value="TG">TG (traumatic)</option>
                            <option value="SOG">SOG (silicone oil)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Steroid Responder, PXS, PDS -->
            <div class="form-row">
                <div class="form-group">
                    <label for="steroid_responder">Steroid Responder</label>
                    <select name="steroid_responder">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="ND" selected>ND</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="pxs">PXS (Pseudoexfoliation Syndrome)</label>
                    <select name="pxs">
                        <option value="0" selected>0</option>
                        <option value="1">1</option>
                        <option value="ND">ND</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="pds">PDS (Pigment Dispersion Syndrome)</label>
                    <select name="pds">
                        <option value="0" selected>0</option>
                        <option value="1">1</option>
                        <option value="ND">ND</option>
                    </select>
                </div>
            </div>

            <!-- Diabetic Retinopathy -->
            <div class="subsection">
                <div class="field-group">
                    <div class="form-group">
                        <label for="diabetic_retinopathy">Diabetic Retinopathy</label>
                        <select id="diabetic_retinopathy" name="diabetic_retinopathy" onchange="handleDR(this.value)">
                            <option value="0" selected>0</option>
                            <option value="1">1</option>
                            <option value="ND">ND</option>
                        </select>
                    </div>
                </div>

                <div id="dr_stage_fields" class="conditional-field">
                    <div class="form-group">
                        <label for="dr_stage">Stage (Diabetic Retinopathy)</label>
                        <select id="dr_stage" name="dr_stage" onchange="handleDRStage(this.value)">
                            <option value="ND" selected>ND</option>
                            <option value="NPDR">NPDR (nonproliferative)</option>
                            <option value="PDR">PDR (proliferative)</option>
                        </select>
                    </div>

                    <div id="npdr_stage_fields" class="conditional-field">
                        <div class="form-group">
                            <label for="npdr_stage">Stage (NPDR)</label>
                            <select name="npdr_stage">
                                <option value="ND" selected>ND</option>
                                <option value="Mild">Mild</option>
                                <option value="Moderate">Moderate</option>
                                <option value="Severe">Severe</option>
                            </select>
                        </div>
                    </div>

                    <div id="pdr_stage_fields" class="conditional-field">
                        <div class="form-group">
                            <label for="pdr_stage">Stage (PDR)</label>
                            <select name="pdr_stage">
                                <option value="ND" selected>ND</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Macular Edema -->
            <div class="subsection">
                <div class="field-group">
                    <div class="form-group">
                        <label for="macular_edema">Macular Edema</label>
                        <select id="macular_edema" name="macular_edema" onchange="handleME(this.value)">
                            <option value="0" selected>0</option>
                            <option value="1">1</option>
                            <option value="ND">ND</option>
                        </select>
                    </div>
                </div>

                <div id="me_etiology_fields" class="conditional-field">
                    <div class="form-group">
                        <label for="me_etiology">Etiology (Macular Edema)</label>
                        <select name="me_etiology">
                            <option value="ND" selected>ND</option>
                            <option value="DME">DME (diabetic macular edema)</option>
                            <option value="RVO-ME">RVO-ME (retinal vein occlusion edema)</option>
                            <option value="IGS">IGS (Irvine-Gass syndrome / pseudophakic CME)</option>
                            <option value="UME">UME (uveitic macular edema)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Macular Degeneration/Dystrophy -->
            <div class="subsection">
                <div class="field-group">
                    <div class="form-group">
                        <label for="macular_degeneration">Macular Degeneration/Dystrophy</label>
                        <select id="macular_degeneration" name="macular_degeneration" onchange="handleMD(this.value)">
                            <option value="0" selected>0</option>
                            <option value="1">1</option>
                            <option value="ND">ND</option>
                        </select>
                    </div>
                </div>

                <div id="md_etiology_fields" class="conditional-field">
                    <div class="form-group">
                        <label for="md_etiology">Etiology</label>
                        <select id="md_etiology" name="md_etiology" onchange="handleMDEtiology(this.value)">
                            <option value="ND" selected>ND</option>
                            <option value="AMD">AMD</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div id="amd_stage_fields" class="conditional-field">
                        <div class="form-group">
                            <label for="amd_stage">Stage (AMD)</label>
                            <select id="amd_stage" name="amd_stage" onchange="handleAMDStage(this.value)">
                                <option value="ND" selected>ND</option>
                                <option value="Early">Early</option>
                                <option value="Intermediate">Intermediate</option>
                                <option value="nAMD">nAMD (neovascular)</option>
                                <option value="GA">GA (geographic atrophy)</option>
                                <option value="nAMD+GA">nAMD+GA (neovascular with atrophy)</option>
                            </select>
                        </div>

                        <div id="amd_exudation_fields" class="conditional-field">
                            <div class="form-group">
                                <label for="amd_exudation">Exudation (AMD)</label>
                                <select name="amd_exudation">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="ND" selected>ND</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="other_md_stage_fields" class="conditional-field">
                        <div class="form-group">
                            <label for="other_md_stage">Stage (Other Macular Degeneration/Dystrophy)</label>
                            <select id="other_md_stage" name="other_md_stage" onchange="handleOtherMDStage(this.value)">
                                <option value="ND" selected>ND</option>
                                <option value="Non-neovascular">Non-neovascular</option>
                                <option value="Neovascular">Neovascular</option>
                            </select>
                        </div>

                        <div id="other_md_exudation_fields" class="conditional-field">
                            <div class="form-group">
                                <label for="other_md_exudation">Exudation (Other Macular Degeneration/Dystrophy)</label>
                                <select name="other_md_exudation">
                                    <option value="0" selected>0</option>
                                    <option value="1">1</option>
                                    <option value="ND">ND</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Macular Hole / Vitreomacular Traction -->
            <div class="subsection">
                <div class="field-group">
                    <div class="form-group">
                        <label for="mh_vmt">Macular Hole / Vitreomacular Traction</label>
                        <select id="mh_vmt" name="mh_vmt" onchange="handleMHVMT(this.value)">
                            <option value="0" selected>0</option>
                            <option value="1">1</option>
                            <option value="ND">ND</option>
                        </select>
                    </div>
                </div>

                <div id="mh_vmt_fields" class="conditional-field">
                    <div class="form-group">
                        <label for="mh_vmt_etiology">Etiology (MH/VMT)</label>
                        <select id="mh_vmt_etiology" name="mh_vmt_etiology" onchange="handleMHVMTEtiology(this.value)">
                            <option value="ND" selected>ND</option>
                            <option value="Idiopathic">Idiopathic</option>
                            <option value="Secondary">Secondary</option>
                        </select>
                    </div>

                    <div id="secondary_mh_vmt_fields" class="conditional-field">
                        <div class="form-group">
                            <label for="secondary_mh_vmt_cause">Cause (Secondary MH/VMT)</label>
                            <select name="secondary_mh_vmt_cause">
                                <option value="ND" selected>ND</option>
                                <option value="MTM">MTM (myopic traction maculopathy)</option>
                                <option value="Retinal detachment">Retinal detachment (rhegmatogenous or tractional)</option>
                                <option value="Ocular trauma or surgery">Ocular trauma or surgery (mechanical or laser trauma, surgery unrelated to MTM or retinal detachment)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="mh_vmt_treatment_status">Treatment Status Prior to Sample Collection (MH/VMT)</label>
                        <select name="mh_vmt_treatment_status">
                            <option value="ND" selected>ND</option>
                            <option value="Untreated">Untreated</option>
                            <option value="Treated-persistent/recurrent">Treated - persistent/recurrent</option>
                            <option value="Treated-closed">Treated - closed</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Epiretinal Membrane -->
            <div class="subsection">
                <div class="field-group">
                    <div class="form-group">
                        <label for="epiretinal_membrane">Epiretinal Membrane</label>
                        <select id="epiretinal_membrane" name="epiretinal_membrane" onchange="handleERM(this.value)">
                            <option value="0" selected>0</option>
                            <option value="1">1</option>
                            <option value="ND">ND</option>
                        </select>
                    </div>
                </div>

                <div id="erm_fields" class="conditional-field">
                    <div class="form-group">
                        <label for="erm_etiology">Etiology (ERM)</label>
                        <select id="erm_etiology" name="erm_etiology" onchange="handleERMEtiology(this.value)">
                            <option value="ND" selected>ND</option>
                            <option value="Idiopathic">Idiopathic</option>
                            <option value="Secondary">Secondary</option>
                        </select>
                    </div>

                    <div id="secondary_erm_fields" class="conditional-field">
                        <div class="form-group">
                            <label for="secondary_erm_cause">Cause (Secondary ERM)</label>
                            <select name="secondary_erm_cause">
                                <option value="ND" selected>ND</option>
                                <option value="DR">DR (diabetic retinopathy)</option>
                                <option value="RVO">RVO (retinal vein occlusion)</option>
                                <option value="Intraocular inflammation">Intraocular inflammation (uveitis, endophthalmitis)</option>
                                <option value="MTM">MTM (myopic traction maculopathy)</option>
                                <option value="Retinal tear">Retinal tear</option>
                                <option value="RD/PVR">RD/PVR (retinal detachment associated ERM)</option>
                                <option value="Ocular trauma or surgery">Ocular trauma or surgery (surgery unrelated to DR, RVO, uveitis/endophthalmitis, MTM, retinal tear or RD/PVR)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="erm_treatment_status">Treatment Status Prior to Sample Collection (ERM)</label>
                        <select name="erm_treatment_status">
                            <option value="ND" selected>ND</option>
                            <option value="Untreated">Untreated</option>
                            <option value="Treated-recurrent">Treated - recurrent</option>
                            <option value="Treated-removed">Treated - removed</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Retinal Detachment/Redetachment -->
            <div class="subsection">
                <div class="field-group">
                    <div class="form-group">
                        <label for="retinal_detachment">Retinal Detachment/Redetachment</label>
                        <select id="retinal_detachment" name="retinal_detachment" onchange="handleRD(this.value)">
                            <option value="0" selected>0</option>
                            <option value="Current detachment">Current detachment</option>
                            <option value="Current redetachment">Current redetachment</option>
                            <option value="Previous detachment">Previous detachment</option>
                            <option value="Previous redetachment">Previous redetachment</option>
                            <option value="ND">ND</option>
                        </select>
                    </div>
                </div>

                <div id="rd_fields" class="conditional-field">
                    <div class="form-group">
                        <label for="rd_etiology">Etiology (RD)</label>
                        <select name="rd_etiology">
                            <option value="ND" selected>ND</option>
                            <option value="Rhegmatogenous">Rhegmatogenous</option>
                            <option value="Tractional">Tractional</option>
                            <option value="Combined">Combined (tractional–rhegmatogenous)</option>
                            <option value="Serous/Exudative">Serous/Exudative</option>
                            <option value="Haemorrhagic">Haemorrhagic</option>
                            <option value="MTM">MTM (myopic traction maculopathy)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="rd_treatment_status">Treatment Status Prior to Sample Collection (RD)</label>
                        <select name="rd_treatment_status">
                            <option value="ND" selected>ND</option>
                            <option value="Untreated">Untreated</option>
                            <option value="Treated (PPV + oil tamponade)">Treated (PPV + oil tamponade)</option>
                            <option value="Treated (PPV + gas tamponade)">Treated (PPV + gas tamponade)</option>
                            <option value="Treated (pneumoretinopexy)">Treated (pneumoretinopexy)</option>
                            <option value="Treated (other procedures)">Treated (other procedures)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="pvr">PVR</label>
                        <select name="pvr">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="ND" selected>ND</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Vitreous Haemorrhage / Other Vitreous Opacification -->
            <div class="subsection">
                <div class="field-group">
                    <div class="form-group">
                        <label for="vitreous_opacification">Vitreous Haemorrhage / Other Vitreous Opacification</label>
                        <select id="vitreous_opacification" name="vitreous_opacification" onchange="handleVO(this.value)">
                            <option value="0" selected>0</option>
                            <option value="Vitreous haemorrhage">Vitreous haemorrhage</option>
                            <option value="Synchisis scintillans">Synchisis scintillans</option>
                            <option value="Asteroid hyalosis">Asteroid hyalosis</option>
                            <option value="Vitritis">Vitritis</option>
                            <option value="Vitreoretinal lymphoma">Vitreoretinal lymphoma</option>
                            <option value="Endophthalmitis">Endophthalmitis</option>
                            <option value="ND">ND</option>
                        </select>
                    </div>
                </div>

                <div id="vh_etiology_fields" class="conditional-field">
                    <div class="form-group">
                        <label for="vh_etiology">Etiology (Vitreous Haemorrhage)</label>
                        <select name="vh_etiology">
                            <option value="ND" selected>ND</option>
                            <option value="PDR">PDR</option>
                            <option value="RVO">RVO</option>
                            <option value="nAMD">nAMD</option>
                            <option value="Retinal tear / Retinal detachment">Retinal tear / Retinal detachment</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== OTHER OCULAR CONDITIONS (ICD-10) ========== -->
        <div class="section-divider">
            <h3 class="section-title">Other Ocular Conditions (ICD-10)</h3>

            <div id="other_ocular_conditions_container">
                <div class="repeatable-item">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ICD-10 Code</label>
                            <select name="other_ocular_condition[]">
                                <option value="0" selected>0</option>
                                <option value="ND">ND</option>
                                {% for code in icd10_ocular %}
                                <option value="{{ code.code }}">{{ code.code }} - {{ code.description }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Eye</label>
                            <select name="other_ocular_condition_eye[]">
                                <option value="ND" selected>ND</option>
                                <option value="R">R</option>
                                <option value="L">L</option>
                                <option value="R+L">R+L</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <button type="button" class="add-more-btn" onclick="addOtherOcularCondition()">+ Add Another Condition</button>
        </div>

        <!-- ========== PREVIOUS OCULAR SURGERY OR LASER TREATMENT ========== -->
        <div class="section-divider">
            <h3 class="section-title">Previous Ocular Surgery or Laser Treatment</h3>

            <div id="previous_surgeries_container">
                <div class="repeatable-item">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Surgery/Procedure</label>
                            <select name="previous_surgery[]">
                                <option value="0" selected>0</option>
                                <option value="ND">ND</option>
                                {% for surgery in surgeries %}
                                <option value="{{ surgery.code }}">{{ surgery.code }} - {{ surgery.description }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Eye</label>
                            <select name="previous_surgery_eye[]">
                                <option value="ND" selected>ND</option>
                                <option value="R">R</option>
                                <option value="L">L</option>
                                <option value="R+L">R+L</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <button type="button" class="add-more-btn" onclick="addPreviousSurgery()">+ Add Another Surgery</button>
        </div>

        <!-- ========== OTHER/SYSTEMIC CONDITIONS (ICD-10) ========== -->
        <div class="section-divider">
            <h3 class="section-title">Other/Systemic Conditions (ICD-10)</h3>

            <div id="systemic_conditions_container">
                <div class="repeatable-item">
                    <div class="form-group">
                        <label>ICD-10 Code</label>
                        <select name="systemic_condition[]">
                            <option value="0" selected>0</option>
                            <option value="ND">ND</option>
                            {% for code in icd10_systemic %}
                            <option value="{{ code.code }}">{{ code.code }} - {{ code.description }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <button type="button" class="add-more-btn" onclick="addSystemicCondition()">+ Add Another Condition</button>
        </div>

        <!-- ========== OCULAR MEDICATIONS ========== -->
        <div class="section-divider">
            <h3 class="section-title">Ocular Medications</h3>

            <div id="ocular_medications_container">
                <div class="repeatable-item">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Medication (Generic Name)</label>
                            <select name="ocular_medication[]">
                                <option value="0" selected>0</option>
                                <option value="ND">ND</option>
                                {% for med in medications %}
                                {% if med.medication_type in ['Ocular', 'Both'] %}
                                <option value="{{ med.trade_name }}|{{ med.generic_name }}">
                                    {{ med.trade_name }} ({{ med.generic_name }})
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Eye</label>
                            <select name="ocular_medication_eye[]">
                                <option value="ND" selected>ND</option>
                                <option value="R">R</option>
                                <option value="L">L</option>
                                <option value="R+L">R+L</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Days Before Collection (000-999)</label>
                            <input type="number" name="ocular_medication_days[]" min="0" max="999" placeholder="000">
                        </div>
                    </div>
                </div>
            </div>

            <button type="button" class="add-more-btn" onclick="addOcularMedication()">+ Add Another Medication</button>
        </div>

        <!-- ========== SYSTEMIC MEDICATIONS ========== -->
        <div class="section-divider">
            <h3 class="section-title">Other/Systemic Medications</h3>

            <div id="systemic_medications_container">
                <div class="repeatable-item">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Medication (Generic Name)</label>
                            <select name="systemic_medication[]">
                                <option value="0" selected>0</option>
                                <option value="ND">ND</option>
                                {% for med in medications %}
                                {% if med.medication_type in ['Systemic', 'Both'] %}
                                <option value="{{ med.trade_name }}|{{ med.generic_name }}">
                                    {{ med.trade_name }} ({{ med.generic_name }})
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Days Before Collection (000-999)</label>
                            <input type="number" name="systemic_medication_days[]" min="0" max="999" placeholder="000">
                        </div>
                    </div>
                </div>
            </div>

            <button type="button" class="add-more-btn" onclick="addSystemicMedication()">+ Add Another Medication</button>
        </div>

        <!-- Submit Buttons -->
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-success">Save Patient</button>
        </div>
    </form>
</div>


<script>
console.log('Patient form JavaScript loaded');

// =====================================================
// NOTIFICATION SYSTEM
// =====================================================
function showNotification(title, message, type = 'info') {
    const container = document.getElementById('notification-container');
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div class="notification-close" onclick="this.parentElement.remove()">×</div>
        <div class="notification-title">${title}</div>
        <div class="notification-message">${message}</div>
    `;

    container.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// =====================================================
// PATIENT ID MANAGEMENT
// =====================================================
let checkTimeout;
let periodicCheckInterval;
let currentPatientId = null;
let isUserEditingId = false;
let lastCheckedId = null;

function checkPatientIdAvailability(id, isPeriodicCheck = false) {
    console.log('Checking Patient ID availability:', id, 'Periodic:', isPeriodicCheck);
    const statusEl = document.getElementById('id-status');

    if (!statusEl) {
        console.error('Status element not found!');
        return;
    }

    if (!isPeriodicCheck) {
        statusEl.className = 'patient-id-status checking';
        statusEl.textContent = 'Checking...';
    }

    const url = `/api/check_patient_id/${id}`;
    console.log('Fetching:', url);

    fetch(url)
        .then(res => {
            console.log('API Response status:', res.status);
            return res.json();
        })
        .then(data => {
            console.log('API Response data:', data);
            if (data.available) {
                statusEl.className = 'patient-id-status available';
                statusEl.textContent = '✓ Available';
                currentPatientId = id;
                lastCheckedId = id;
            } else {
                statusEl.className = 'patient-id-status unavailable';
                statusEl.textContent = '✗ Already taken';

                if (isPeriodicCheck && lastCheckedId === id) {
                    showNotification(
                        'Patient ID No Longer Available',
                        `ID ${id} was taken by another user. Auto-incrementing to next available ID...`,
                        'warning'
                    );
                    fetchNextAvailableId();
                }
                lastCheckedId = id;
            }
        })
        .catch(error => {
            console.error('Error checking patient ID:', error);
            statusEl.className = 'patient-id-status checking';
            statusEl.textContent = 'Error checking ID';
        });
}

function fetchNextAvailableId() {
    console.log('Fetching next available ID');
    fetch('/api/next_available_patient_id')
        .then(res => res.json())
        .then(data => {
            console.log('Next ID response:', data);
            if (data.next_id) {
                document.getElementById('patient_id').value = data.next_id;
                currentPatientId = data.next_id;
                checkPatientIdAvailability(data.next_id);
                setTimeout(() => {
                    showNotification('ID Updated', `Patient ID has been updated to ${data.next_id}`, 'success');
                }, 500);
            }
        })
        .catch(error => {
            console.error('Error fetching next ID:', error);
            showNotification('Error', 'Could not fetch next available ID. Please enter manually.', 'error');
        });
}

function periodicIdCheck() {
    if (!isUserEditingId) {
        const currentId = parseInt(document.getElementById('patient_id').value);
        if (currentId && currentId >= 1 && currentId <= 99999) {
            checkPatientIdAvailability(currentId, true);
        }
    }
}

// =====================================================
// CONDITIONAL FIELD HANDLERS
// =====================================================
function handleLensStatus(value) {
    console.log('handleLensStatus called with:', value);
    const locsFields = document.getElementById('locs_fields');
    const iolFields = document.getElementById('iol_fields');
    const aphakiaFields = document.getElementById('aphakia_fields');

    if (locsFields) {
        if (value === 'Phakic') {
            locsFields.classList.add('active');
            console.log('LOCS fields activated');
        } else {
            locsFields.classList.remove('active');
        }
    }
    if (iolFields) {
        if (value === 'Pseudophakic') {
            iolFields.classList.add('active');
        } else {
            iolFields.classList.remove('active');
        }
    }
    if (aphakiaFields) {
        if (value === 'Aphakic') {
            aphakiaFields.classList.add('active');
        } else {
            aphakiaFields.classList.remove('active');
        }
    }
}

function handleGlaucoma(value) {
    console.log('handleGlaucoma called with:', value);
    const ohtPacFields = document.getElementById('oht_pac_fields');
    const glaucomaEtiologyFields = document.getElementById('glaucoma_etiology_fields');

    if (ohtPacFields) {
        if (value === '0') {
            ohtPacFields.classList.add('active');
            console.log('OHT/PAC fields activated');
        } else {
            ohtPacFields.classList.remove('active');
        }
    }
    if (glaucomaEtiologyFields) {
        if (value === '1') {
            glaucomaEtiologyFields.classList.add('active');
            console.log('Glaucoma etiology fields activated');
        } else {
            glaucomaEtiologyFields.classList.remove('active');
        }
    }
}

function handleDR(value) {
    const drStageFields = document.getElementById('dr_stage_fields');
    if (drStageFields) {
        if (value === '1') {
            drStageFields.classList.add('active');
        } else {
            drStageFields.classList.remove('active');
        }
    }
}

function handleDRStage(value) {
    const npdrFields = document.getElementById('npdr_stage_fields');
    const pdrFields = document.getElementById('pdr_stage_fields');

    if (npdrFields) {
        if (value === 'NPDR') {
            npdrFields.classList.add('active');
        } else {
            npdrFields.classList.remove('active');
        }
    }
    if (pdrFields) {
        if (value === 'PDR') {
            pdrFields.classList.add('active');
        } else {
            pdrFields.classList.remove('active');
        }
    }
}

function handleME(value) {
    const meEtiologyFields = document.getElementById('me_etiology_fields');
    if (meEtiologyFields) {
        if (value === '1') {
            meEtiologyFields.classList.add('active');
        } else {
            meEtiologyFields.classList.remove('active');
        }
    }
}

function handleMD(value) {
    const mdEtiologyFields = document.getElementById('md_etiology_fields');
    if (mdEtiologyFields) {
        if (value === '1') {
            mdEtiologyFields.classList.add('active');
        } else {
            mdEtiologyFields.classList.remove('active');
        }
    }
}

function handleMDEtiology(value) {
    const amdStageFields = document.getElementById('amd_stage_fields');
    const otherMdStageFields = document.getElementById('other_md_stage_fields');

    if (amdStageFields) {
        if (value === 'AMD') {
            amdStageFields.classList.add('active');
        } else {
            amdStageFields.classList.remove('active');
        }
    }
    if (otherMdStageFields) {
        if (value === 'Other' || value === 'ND') {
            otherMdStageFields.classList.add('active');
        } else {
            otherMdStageFields.classList.remove('active');
        }
    }
}

function handleAMDStage(value) {
    const amdExudationFields = document.getElementById('amd_exudation_fields');
    if (amdExudationFields) {
        if (value === 'nAMD' || value === 'nAMD+GA' || value === 'ND') {
            amdExudationFields.classList.add('active');
        } else {
            amdExudationFields.classList.remove('active');
        }
    }
}

function handleOtherMDStage(value) {
    const otherMdExudationFields = document.getElementById('other_md_exudation_fields');
    if (otherMdExudationFields) {
        if (value !== '' && value !== '0') {
            otherMdExudationFields.classList.add('active');
        } else {
            otherMdExudationFields.classList.remove('active');
        }
    }
}

function handleMHVMT(value) {
    const mhVmtFields = document.getElementById('mh_vmt_fields');
    if (mhVmtFields) {
        if (value === '1') {
            mhVmtFields.classList.add('active');
        } else {
            mhVmtFields.classList.remove('active');
        }
    }
}

function handleMHVMTEtiology(value) {
    const secondaryMhVmtFields = document.getElementById('secondary_mh_vmt_fields');
    if (secondaryMhVmtFields) {
        if (value === 'Secondary') {
            secondaryMhVmtFields.classList.add('active');
        } else {
            secondaryMhVmtFields.classList.remove('active');
        }
    }
}

function handleERM(value) {
    const ermFields = document.getElementById('erm_fields');
    if (ermFields) {
        if (value === '1') {
            ermFields.classList.add('active');
        } else {
            ermFields.classList.remove('active');
        }
    }
}

function handleERMEtiology(value) {
    const secondaryErmFields = document.getElementById('secondary_erm_fields');
    if (secondaryErmFields) {
        if (value === 'Secondary') {
            secondaryErmFields.classList.add('active');
        } else {
            secondaryErmFields.classList.remove('active');
        }
    }
}

function handleRD(value) {
    const rdFields = document.getElementById('rd_fields');
    if (rdFields) {
        if (value !== '0' && value !== '') {
            rdFields.classList.add('active');
        } else {
            rdFields.classList.remove('active');
        }
    }
}

function handleVO(value) {
    const vhEtiologyFields = document.getElementById('vh_etiology_fields');
    if (vhEtiologyFields) {
        if (value === 'Vitreous haemorrhage') {
            vhEtiologyFields.classList.add('active');
        } else {
            vhEtiologyFields.classList.remove('active');
        }
    }
}

// =====================================================
// REPEATABLE ITEMS
// =====================================================
function addOtherOcularCondition() {
    const container = document.getElementById('other_ocular_conditions_container');
    if (!container) return;
    const item = container.firstElementChild.cloneNode(true);
    item.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'remove-btn';
    removeBtn.textContent = '✕ Remove';
    removeBtn.onclick = function() { this.parentElement.remove(); };
    item.appendChild(removeBtn);
    container.appendChild(item);
}

function addPreviousSurgery() {
    const container = document.getElementById('previous_surgeries_container');
    if (!container) return;
    const item = container.firstElementChild.cloneNode(true);
    item.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'remove-btn';
    removeBtn.textContent = '✕ Remove';
    removeBtn.onclick = function() { this.parentElement.remove(); };
    item.appendChild(removeBtn);
    container.appendChild(item);
}

function addSystemicCondition() {
    const container = document.getElementById('systemic_conditions_container');
    if (!container) return;
    const item = container.firstElementChild.cloneNode(true);
    item.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'remove-btn';
    removeBtn.textContent = '✕ Remove';
    removeBtn.onclick = function() { this.parentElement.remove(); };
    item.appendChild(removeBtn);
    container.appendChild(item);
}

function addOcularMedication() {
    const container = document.getElementById('ocular_medications_container');
    if (!container) return;
    const item = container.firstElementChild.cloneNode(true);
    item.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
    item.querySelectorAll('input').forEach(input => input.value = '');
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'remove-btn';
    removeBtn.textContent = '✕ Remove';
    removeBtn.onclick = function() { this.parentElement.remove(); };
    item.appendChild(removeBtn);
    container.appendChild(item);
}

function addSystemicMedication() {
    const container = document.getElementById('systemic_medications_container');
    if (!container) return;
    const item = container.firstElementChild.cloneNode(true);
    item.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
    item.querySelectorAll('input').forEach(input => input.value = '');
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'remove-btn';
    removeBtn.textContent = '✕ Remove';
    removeBtn.onclick = function() { this.parentElement.remove(); };
    item.appendChild(removeBtn);
    container.appendChild(item);
}

// =====================================================
// FORM VALIDATION
// =====================================================
function validateForm() {
    clearInterval(periodicCheckInterval);
    const idStatus = document.getElementById('id-status');
    if (idStatus && idStatus.textContent.includes('Already taken')) {
        showNotification('Invalid Patient ID', 'Patient ID is already in use. Please choose a different ID.', 'error');
        periodicCheckInterval = setInterval(periodicIdCheck, 3000);
        return false;
    }
    const mbo = document.getElementById('mbo').value;
    if (!/^\d{9}$/.test(mbo)) {
        showNotification('Invalid MBO', 'MBO must be exactly 9 digits.', 'error');
        periodicCheckInterval = setInterval(periodicIdCheck, 3000);
        return false;
    }
    const dobDay = document.querySelector('[name="dob_day"]').value;
    const dobMonth = document.querySelector('[name="dob_month"]').value;
    const dobYear = document.querySelector('[name="dob_year"]').value;
    const colDay = document.querySelector('[name="collection_day"]').value;
    const colMonth = document.querySelector('[name="collection_month"]').value;
    const colYear = document.querySelector('[name="collection_year"]').value;
    if (!dobDay || !dobMonth || !dobYear || !colDay || !colMonth || !colYear) {
        showNotification('Incomplete Dates', 'Please fill in all date fields.', 'error');
        periodicCheckInterval = setInterval(periodicIdCheck, 3000);
        return false;
    }
    const dob = new Date(dobYear, dobMonth - 1, dobDay);
    const collection = new Date(colYear, colMonth - 1, colDay);
    if (collection <= dob) {
        showNotification('Invalid Dates', 'Date of sample collection must be after date of birth.', 'error');
        periodicCheckInterval = setInterval(periodicIdCheck, 3000);
        return false;
    }
    if (confirm('Are you sure you want to save this patient record?')) {
        return true;
    } else {
        periodicCheckInterval = setInterval(periodicIdCheck, 3000);
        return false;
    }
}

// =====================================================
// INITIALIZATION
// =====================================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - Initializing...');

    const patientIdField = document.getElementById('patient_id');
    console.log('Patient ID field:', patientIdField);
    console.log('Patient ID value:', patientIdField ? patientIdField.value : 'Field not found');

    if (patientIdField && patientIdField.value) {
        currentPatientId = parseInt(patientIdField.value);
        lastCheckedId = currentPatientId;
        console.log('Starting ID check for:', currentPatientId);
        checkPatientIdAvailability(currentPatientId);
        console.log('Starting periodic checking (every 3 seconds)');
        periodicCheckInterval = setInterval(periodicIdCheck, 3000);

        patientIdField.addEventListener('input', function() {
            isUserEditingId = true;
            clearTimeout(checkTimeout);
            const id = parseInt(this.value);
            if (id && id >= 1 && id <= 99999) {
                checkTimeout = setTimeout(() => {
                    checkPatientIdAvailability(id);
                    isUserEditingId = false;
                }, 500);
            }
        });

        patientIdField.addEventListener('blur', function() {
            isUserEditingId = false;
            const id = parseInt(this.value);
            if (id && id >= 1 && id <= 99999) {
                checkPatientIdAvailability(id);
            }
        });
    } else {
        console.warn('Patient ID field not found or has no value!');
    }

    const form = document.getElementById('patientForm');
    if (form) {
        console.log('Form found, adding submit handler');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (validateForm()) {
                this.submit();
            }
        });
    } else {
        console.warn('Form not found!');
    }

    console.log('Initializing conditional fields...');
    const lensStatus = document.getElementById('lens_status');
    if (lensStatus) {
        console.log('Lens Status found, value:', lensStatus.value);
        handleLensStatus(lensStatus.value);
    }
    const glaucoma = document.getElementById('glaucoma');
    if (glaucoma) {
        console.log('Glaucoma found, value:', glaucoma.value);
        handleGlaucoma(glaucoma.value);
    }
    const dr = document.getElementById('diabetic_retinopathy');
    if (dr) handleDR(dr.value);
    const drStage = document.getElementById('dr_stage');
    if (drStage) handleDRStage(drStage.value);
    const me = document.getElementById('macular_edema');
    if (me) handleME(me.value);
    const md = document.getElementById('macular_degeneration');
    if (md) handleMD(md.value);
    const mdEtiology = document.getElementById('md_etiology');
    if (mdEtiology) handleMDEtiology(mdEtiology.value);
    const amdStage = document.getElementById('amd_stage');
    if (amdStage) handleAMDStage(amdStage.value);
    const otherMdStage = document.getElementById('other_md_stage');
    if (otherMdStage) handleOtherMDStage(otherMdStage.value);
    const mhVmt = document.getElementById('mh_vmt');
    if (mhVmt) handleMHVMT(mhVmt.value);
    const mhVmtEtiology = document.getElementById('mh_vmt_etiology');
    if (mhVmtEtiology) handleMHVMTEtiology(mhVmtEtiology.value);
    const erm = document.getElementById('epiretinal_membrane');
    if (erm) handleERM(erm.value);
    const ermEtiology = document.getElementById('erm_etiology');
    if (ermEtiology) handleERMEtiology(ermEtiology.value);
    const rd = document.getElementById('retinal_detachment');
    if (rd) handleRD(rd.value);
    const vo = document.getElementById('vitreous_opacification');
    if (vo) handleVO(vo.value);
    console.log('Initialization complete!');
});

window.addEventListener('beforeunload', function() {
    if (periodicCheckInterval) {
        clearInterval(periodicCheckInterval);
    }
});
</script>
{% endblock %}