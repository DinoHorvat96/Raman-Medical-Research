<!-- templates/export_data.html -->
{% extends "base.html" %}

{% block title %}Export Data - Raman{% endblock %}

{% block content %}
<style>
    .export-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        text-align: center;
    }

    .stat-value {
        font-size: 36px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 10px;
    }

    .stat-label {
        color: #7f8c8d;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .export-options {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .option-group {
        margin-bottom: 25px;
        padding-bottom: 25px;
        border-bottom: 1px solid #ecf0f1;
    }

    .option-group:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .option-title {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 16px;
    }

    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .checkbox-item label {
        cursor: pointer;
        user-select: none;
        color: #34495e;
    }

    .format-options {
        display: flex;
        gap: 20px;
    }

    .radio-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .radio-item input[type="radio"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .radio-item label {
        cursor: pointer;
        user-select: none;
        color: #34495e;
    }

    .export-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 30px;
    }

    .btn-export {
        background: #27ae60;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-export:hover {
        background: #229954;
    }

    .age-distribution {
        margin-top: 20px;
    }

    .age-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }

    .age-label {
        width: 60px;
        font-size: 13px;
        color: #7f8c8d;
    }

    .age-progress {
        flex: 1;
        height: 20px;
        background: #ecf0f1;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
    }

    .age-fill {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #2980b9);
        border-radius: 4px;
        transition: width 0.3s;
    }

    .age-count {
        width: 40px;
        text-align: right;
        font-size: 13px;
        color: #2c3e50;
        font-weight: 600;
    }

    .info-box {
        background: #e8f4f8;
        border-left: 4px solid #3498db;
        padding: 15px 20px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    .info-box p {
        margin: 0;
        color: #2c3e50;
        font-size: 14px;
        line-height: 1.6;
    }

    .warning-box {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px 20px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    .warning-box p {
        margin: 0;
        color: #856404;
        font-size: 14px;
        line-height: 1.6;
    }

    /* Filtering styles */
    .filter-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        margin-bottom: 15px;
        overflow: hidden;
    }

    .filter-header {
        padding: 15px 20px;
        background: #e9ecef;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
    }

    .filter-header:hover {
        background: #dee2e6;
    }

    .filter-header-title {
        font-weight: 600;
        color: #2c3e50;
        font-size: 15px;
    }

    .filter-toggle {
        font-size: 18px;
        color: #6c757d;
        transition: transform 0.3s;
    }

    .filter-toggle.expanded {
        transform: rotate(180deg);
    }

    .filter-content {
        padding: 20px;
        display: none;
    }

    .filter-content.show {
        display: block;
    }

    .filter-field {
        margin-bottom: 20px;
    }

    .filter-field-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .filter-field-select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        background: white;
    }

    .filter-field-select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
    }
</style>

<div class="export-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2>Export Statistical Data</h2>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
    </div>

    {% if session.role == 'Staff' %}
    <div class="warning-box">
        <p><strong>Staff Access:</strong> You can only export anonymized data. Patient names and MBO numbers are not included in your exports.</p>
    </div>
    {% endif %}

    {% if session.role == 'Administrator' %}
    <div class="info-box">
        <p><strong>Administrator Access:</strong> You can export both sensitive and anonymized data. Choose your preferred format below.</p>
    </div>
    {% else %}
    <div class="info-box">
        <p><strong>Note:</strong> All exported data is anonymized for statistical analysis. Person Hash is used to identify multiple entries from the same individual.</p>
    </div>
    {% endif %}

    <!-- Statistics Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_patients|default(0) }}</div>
            <div class="stat-label">Total Patients</div>
        </div>

        <div class="stat-card">
            <div class="stat-value">{{ stats.gender.M|default(0) }}</div>
            <div class="stat-label">Male Patients</div>
        </div>

        <div class="stat-card">
            <div class="stat-value">{{ stats.gender.F|default(0) }}</div>
            <div class="stat-label">Female Patients</div>
        </div>
    </div>

    {% if stats.age_distribution %}
    <div class="card" style="margin-bottom: 30px;">
        <h3 style="margin-bottom: 20px; color: #2c3e50;">Age Distribution</h3>
        <div class="age-distribution">
            {% set max_count = stats.age_distribution|map(attribute=1)|max|default(1) %}
            {% for age_group, count in stats.age_distribution %}
            <div class="age-bar">
                <div class="age-label">{{ age_group }}</div>
                <div class="age-progress">
                    <div class="age-fill" style="width: {{ (count / max_count * 100)|round|int }}%"></div>
                </div>
                <div class="age-count">{{ count }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Export Options -->
    <div class="export-options">
        <h3 style="margin-bottom: 25px; color: #2c3e50;">Export Options</h3>

        <form method="POST" id="exportForm">
            <div class="option-group">
                <div class="option-title">Export Format</div>
                <div class="format-options">
                    <div class="radio-item">
                        <input type="radio" id="format_csv" name="format" value="csv" checked>
                        <label for="format_csv">CSV (Excel Compatible)</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="format_excel" name="format" value="excel">
                        <label for="format_excel">Excel (.xlsx)</label>
                    </div>
                </div>
            </div>

            {% if session.role == 'Administrator' %}
            <div class="option-group">
                <div class="option-title">Data Privacy Level (Administrator Only)</div>
                <div class="format-options">
                    <div class="radio-item">
                        <input type="radio" id="data_type_anonymized" name="data_type" value="anonymized" checked>
                        <label for="data_type_anonymized">Anonymized (Person Hash, no names/MBO)</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="data_type_sensitive" name="data_type" value="sensitive">
                        <label for="data_type_sensitive">Sensitive (Includes Patient Names & MBO)</label>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="option-group">
                <div class="option-title">Data to Include</div>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="include_basic" checked disabled>
                        <label for="include_basic">Basic Demographics (Age, Sex, Eye) - Always Included</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="include_conditions" name="include_conditions" checked>
                        <label for="include_conditions">Main Ocular Conditions</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="include_other_conditions" name="include_other_conditions" checked>
                        <label for="include_other_conditions">Other Ocular Conditions (ICD-10)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="include_surgeries" name="include_surgeries" checked>
                        <label for="include_surgeries">Previous Surgeries & Laser Treatments</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="include_systemic" name="include_systemic" checked>
                        <label for="include_systemic">Systemic Conditions</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="include_medications" name="include_medications" checked>
                        <label for="include_medications">Medications (Ocular & Systemic)</label>
                    </div>
                </div>
            </div>

            <!-- Patient Filters -->
            <div class="option-group">
                <div class="option-title">Patient Filters (Optional)</div>
                <p style="color: #6c757d; font-size: 13px; margin-bottom: 15px;">
                    Filter patients based on specific conditions, surgeries, or medications. Leave filters empty to include all patients.
                </p>

                <!-- Main Ocular Conditions Filters -->
                <div class="filter-section">
                    <div class="filter-header" onclick="toggleFilterSection('mainOcularFilters')">
                        <span class="filter-header-title">Main Ocular Conditions</span>
                        <span class="filter-toggle" id="mainOcularFilters-toggle">‚ñº</span>
                    </div>
                    <div class="filter-content" id="mainOcularFilters">
                        <div class="filter-grid">
                            <div class="filter-field">
                                <div class="filter-field-label">Glaucoma</div>
                                <select name="filter_glaucoma" class="filter-field-select">
                                    <option value="">No filter</option>
                                    <option value="all">All values</option>
                                    <option value="0">0 (No)</option>
                                    <option value="1">1 (Yes)</option>
                                    <option value="ND">ND</option>
                                    <option value="not_0_not_nd">Not 0, not ND</option>
                                </select>
                            </div>

                            <div class="filter-field">
                                <div class="filter-field-label">Diabetic Retinopathy</div>
                                <select name="filter_diabetic_retinopathy" class="filter-field-select">
                                    <option value="">No filter</option>
                                    <option value="all">All values</option>
                                    <option value="0">0 (No)</option>
                                    <option value="1">1 (Yes)</option>
                                    <option value="ND">ND</option>
                                    <option value="not_0_not_nd">Not 0, not ND</option>
                                </select>
                            </div>

                            <div class="filter-field">
                                <div class="filter-field-label">Lens Status</div>
                                <select name="filter_lens_status" class="filter-field-select">
                                    <option value="">No filter</option>
                                    <option value="all">All values</option>
                                    <option value="Phakic">Phakic</option>
                                    <option value="Pseudophakic">Pseudophakic</option>
                                    <option value="Aphakic">Aphakic</option>
                                    <option value="ND">ND</option>
                                </select>
                            </div>

                            <div class="filter-field">
                                <div class="filter-field-label">Macular Edema</div>
                                <select name="filter_macular_edema" class="filter-field-select">
                                    <option value="">No filter</option>
                                    <option value="all">All values</option>
                                    <option value="0">0 (No)</option>
                                    <option value="1">1 (Yes)</option>
                                    <option value="ND">ND</option>
                                    <option value="not_0_not_nd">Not 0, not ND</option>
                                </select>
                            </div>

                            <div class="filter-field">
                                <div class="filter-field-label">Macular Degeneration/Dystrophy</div>
                                <select name="filter_macular_degeneration" class="filter-field-select">
                                    <option value="">No filter</option>
                                    <option value="all">All values</option>
                                    <option value="0">0 (No)</option>
                                    <option value="1">1 (Yes)</option>
                                    <option value="ND">ND</option>
                                    <option value="not_0_not_nd">Not 0, not ND</option>
                                </select>
                            </div>

                            <div class="filter-field">
                                <div class="filter-field-label">Epiretinal Membrane</div>
                                <select name="filter_epiretinal_membrane" class="filter-field-select">
                                    <option value="">No filter</option>
                                    <option value="all">All values</option>
                                    <option value="0">0 (No)</option>
                                    <option value="1">1 (Yes)</option>
                                    <option value="ND">ND</option>
                                    <option value="not_0_not_nd">Not 0, not ND</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other Ocular Conditions Filters -->
                <div class="filter-section">
                    <div class="filter-header" onclick="toggleFilterSection('otherOcularFilters')">
                        <span class="filter-header-title">Other Ocular Conditions (ICD-10)</span>
                        <span class="filter-toggle" id="otherOcularFilters-toggle">‚ñº</span>
                    </div>
                    <div class="filter-content" id="otherOcularFilters">
                        <div class="filter-field">
                            <div class="filter-field-label">Filter by Other Ocular Conditions</div>
                            <select name="filter_other_ocular_mode" class="filter-field-select">
                                <option value="">No filter</option>
                                <option value="all">All values (has any condition)</option>
                                <option value="0">0 (has no conditions)</option>
                                <option value="ND">ND</option>
                                <option value="not_0_not_nd">Not 0, not ND (has at least one condition)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Surgeries Filters -->
                <div class="filter-section">
                    <div class="filter-header" onclick="toggleFilterSection('surgeriesFilters')">
                        <span class="filter-header-title">Previous Surgeries & Laser Treatments</span>
                        <span class="filter-toggle" id="surgeriesFilters-toggle">‚ñº</span>
                    </div>
                    <div class="filter-content" id="surgeriesFilters">
                        <div class="filter-field">
                            <div class="filter-field-label">Filter by Surgeries</div>
                            <select name="filter_surgeries_mode" class="filter-field-select">
                                <option value="">No filter</option>
                                <option value="all">All values (has any surgery)</option>
                                <option value="0">0 (has no surgeries)</option>
                                <option value="ND">ND</option>
                                <option value="not_0_not_nd">Not 0, not ND (has at least one surgery)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Medications Filters -->
                <div class="filter-section">
                    <div class="filter-header" onclick="toggleFilterSection('medicationsFilters')">
                        <span class="filter-header-title">Medications</span>
                        <span class="filter-toggle" id="medicationsFilters-toggle">‚ñº</span>
                    </div>
                    <div class="filter-content" id="medicationsFilters">
                        <div class="filter-grid">
                            <div class="filter-field">
                                <div class="filter-field-label">Filter by Ocular Medications</div>
                                <select name="filter_ocular_meds_mode" class="filter-field-select">
                                    <option value="">No filter</option>
                                    <option value="all">All values (has any medication)</option>
                                    <option value="0">0 (has no medications)</option>
                                    <option value="ND">ND</option>
                                    <option value="not_0_not_nd">Not 0, not ND (has at least one medication)</option>
                                </select>
                            </div>

                            <div class="filter-field">
                                <div class="filter-field-label">Filter by Systemic Medications</div>
                                <select name="filter_systemic_meds_mode" class="filter-field-select">
                                    <option value="">No filter</option>
                                    <option value="all">All values (has any medication)</option>
                                    <option value="0">0 (has no medications)</option>
                                    <option value="ND">ND</option>
                                    <option value="not_0_not_nd">Not 0, not ND (has at least one medication)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="option-group">
                <div class="option-title">Date Range (Optional)</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="date_from">From Date</label>
                        <input type="date" id="date_from" name="date_from">
                    </div>
                    <div class="form-group">
                        <label for="date_to">To Date</label>
                        <input type="date" id="date_to" name="date_to">
                    </div>
                </div>
            </div>

            <div class="export-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='{{ url_for('dashboard') }}'">Cancel</button>
                <button type="submit" class="btn-export">
                    <span>üìä</span>
                    <span>Export Data</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Toggle filter section visibility
function toggleFilterSection(sectionId) {
    const content = document.getElementById(sectionId);
    const toggle = document.getElementById(sectionId + '-toggle');

    if (content.classList.contains('show')) {
        content.classList.remove('show');
        toggle.classList.remove('expanded');
    } else {
        content.classList.add('show');
        toggle.classList.add('expanded');
    }
}

document.getElementById('exportForm').addEventListener('submit', function(e) {
    // Show loading indicator
    const button = e.target.querySelector('.btn-export');
    const originalText = button.innerHTML;
    button.innerHTML = '<span>‚è≥</span><span>Generating Export...</span>';
    button.disabled = true;

    // Re-enable after a timeout (in case of error)
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 10000);
});
</script>

{% endblock %}