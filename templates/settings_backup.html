<!-- templates/settings_backup.html -->
{% extends "base.html" %}

{% block title %}Backup & Restore - Settings{% endblock %}

{% block content %}
<style>
    .backup-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .backup-section {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 30px;
    }

    .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #ecf0f1;
    }

    .backup-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .control-group {
        display: flex;
        flex-direction: column;
    }

    .control-group label {
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .directory-input-wrapper {
        display: flex;
        gap: 10px;
    }

    .directory-input {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
    }

    .btn-browse {
        padding: 10px 20px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-browse:hover {
        background: #2980b9;
    }

    .schedule-select {
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background: white;
    }

    .backup-actions {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .btn-backup {
        padding: 12px 30px;
        background: #27ae60;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
    }

    .btn-backup:hover {
        background: #229954;
    }

    .btn-save {
        padding: 12px 30px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
    }

    .btn-save:hover {
        background: #2980b9;
    }

    .backup-list {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .list-header {
        padding: 20px 30px;
        background: #f8f9fa;
        border-bottom: 2px solid #ecf0f1;
    }

    .backup-table {
        width: 100%;
        border-collapse: collapse;
    }

    .backup-table th {
        background: #f8f9fa;
        padding: 15px 20px;
        text-align: left;
        font-weight: 600;
        color: #2c3e50;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #ecf0f1;
    }

    .backup-table td {
        padding: 15px 20px;
        border-bottom: 1px solid #ecf0f1;
        font-size: 14px;
    }

    .backup-table tr:hover {
        background: #f8f9fa;
    }

    .backup-actions-cell {
        display: flex;
        gap: 8px;
    }

    .btn-restore {
        padding: 6px 12px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }

    .btn-restore:hover {
        background: #2980b9;
    }

    .btn-delete {
        padding: 6px 12px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }

    .btn-delete:hover {
        background: #c0392b;
    }

    .btn-download {
        padding: 6px 12px;
        background: #95a5a6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }

    .btn-download:hover {
        background: #7f8c8d;
    }

    /* Directory Browser Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #ecf0f1;
    }

    .modal-title {
        font-size: 20px;
        color: #2c3e50;
        font-weight: 600;
    }

    .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        color: #7f8c8d;
        cursor: pointer;
    }

    .close-modal:hover {
        color: #2c3e50;
    }

    .current-path {
        padding: 10px 15px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 20px;
        font-family: monospace;
        font-size: 14px;
    }

    .directory-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 6px;
    }

    .directory-item {
        padding: 12px 15px;
        border-bottom: 1px solid #ecf0f1;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .directory-item:hover {
        background: #f8f9fa;
    }

    .dir-icon {
        font-size: 18px;
    }

    .dir-name {
        flex: 1;
        font-size: 14px;
    }

    .info-box {
        background: #e8f4f8;
        border-left: 4px solid #3498db;
        padding: 15px 20px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    .info-box h4 {
        margin: 0 0 10px 0;
        color: #2c3e50;
    }

    .info-box p {
        margin: 0;
        color: #34495e;
        font-size: 14px;
    }

    .status-indicator {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
    }

    .status-enabled {
        background: #d4edda;
        color: #155724;
    }

    .status-disabled {
        background: #f8d7da;
        color: #721c24;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: #27ae60;
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }
</style>

<div class="backup-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2>Database Backup & Restore</h2>
        <a href="{{ url_for('settings') }}" class="btn btn-secondary">Back to Settings</a>
    </div>

    <div class="info-box">
        <h4>‚ö†Ô∏è Important Information</h4>
        <p>‚Ä¢ Backups contain all patient data, user accounts, and system settings</p>
        <p>‚Ä¢ Restoring a backup will replace ALL current data</p>
        <p>‚Ä¢ Always create a new backup before restoring an old one</p>
        <p>‚Ä¢ Scheduled backups run automatically based on your settings</p>
    </div>

    <!-- Backup Configuration Section -->
    <div class="backup-section">
        <h3 class="section-title">Backup Configuration</h3>

        <div class="backup-controls">
            <div class="control-group">
                <label for="backup_dir">Backup Directory</label>
                <div class="directory-input-wrapper">
                    <input type="text" id="backup_dir" class="directory-input"
                           value="{{ config.backup_dir }}" placeholder="/backups/raman">
                    <button onclick="openDirectoryBrowser()" class="btn-browse">Browse</button>
                </div>
            </div>

            <div class="control-group">
                <label for="schedule">Backup Schedule</label>
                <select id="schedule" class="schedule-select">
                    <option value="disabled" {% if config.schedule == 'disabled' %}selected{% endif %}>Disabled</option>
                    <option value="hourly" {% if config.schedule == 'hourly' %}selected{% endif %}>Hourly</option>
                    <option value="daily" {% if config.schedule == 'daily' %}selected{% endif %}>Daily (2:00 AM)</option>
                    <option value="weekly" {% if config.schedule == 'weekly' %}selected{% endif %}>Weekly (Monday 2:00 AM)</option>
                    <option value="monthly" {% if config.schedule == 'monthly' %}selected{% endif %}>Monthly (1st day 2:00 AM)</option>
                </select>
            </div>

            <div class="control-group">
                <label for="retention">Retention Period (days)</label>
                <input type="number" id="retention" class="directory-input"
                       value="{{ config.retention_days }}" min="1" max="365">
            </div>

            <div class="control-group">
                <label for="auto_backup">Automatic Backups</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="auto_backup"
                           {% if config.auto_backup_enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
                <span class="status-indicator {% if config.auto_backup_enabled %}status-enabled{% else %}status-disabled{% endif %}">
                    {% if config.auto_backup_enabled %}Enabled{% else %}Disabled{% endif %}
                </span>
            </div>
        </div>

        <div class="backup-actions">
            <button onclick="createBackup()" class="btn-backup">üîí Create Backup Now</button>
            <button onclick="saveConfiguration()" class="btn-save">üíæ Save Configuration</button>
        </div>
    </div>

    <!-- Existing Backups Section -->
    <div class="backup-list">
        <div class="list-header">
            <h3 style="margin: 0;">Existing Backups ({{ backups|length }})</h3>
        </div>

        {% if backups %}
        <table class="backup-table">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Size</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for backup in backups %}
                <tr>
                    <td><strong>{{ backup.filename }}</strong></td>
                    <td>{{ backup.size }}</td>
                    <td>{{ backup.created }}</td>
                    <td>
                        <div class="backup-actions-cell">
                            <button onclick="restoreBackup('{{ backup.filename }}')"
                                    class="btn-restore">Restore</button>
                            <button onclick="downloadBackup('{{ backup.filename }}')"
                                    class="btn-download">Download</button>
                            <button onclick="deleteBackup('{{ backup.filename }}')"
                                    class="btn-delete">Delete</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
            <p>No backups found. Create your first backup using the button above.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Directory Browser Modal -->
<div id="directoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Select Backup Directory</h3>
            <button class="close-modal" onclick="closeModal()">&times;</button>
        </div>

        <div class="current-path" id="currentPath">/</div>

        <div class="directory-list" id="directoryList">
            <!-- Directory items will be loaded here -->
        </div>

        <div style="margin-top: 20px; display: flex; justify-content: space-between;">
            <button onclick="selectCurrentDirectory()" class="btn btn-success">Select This Directory</button>
            <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<script>
let currentBrowsePath = '/';

function openDirectoryBrowser() {
    document.getElementById('directoryModal').classList.add('active');
    browseDirectory('/');
}

function closeModal() {
    document.getElementById('directoryModal').classList.remove('active');
}

async function browseDirectory(path) {
    try {
        const response = await fetch('/api/browse-directory', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({path: path})
        });

        const data = await response.json();

        if (response.ok) {
            currentBrowsePath = data.current_path;
            document.getElementById('currentPath').textContent = currentBrowsePath;

            const listContainer = document.getElementById('directoryList');
            listContainer.innerHTML = '';

            data.entries.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'directory-item';
                item.onclick = () => browseDirectory(entry.path);

                item.innerHTML = `
                    <span class="dir-icon">${entry.name === '..' ? '‚Ü©Ô∏è' : 'üìÅ'}</span>
                    <span class="dir-name">${entry.name}</span>
                `;

                listContainer.appendChild(item);
            });
        } else {
            alert('Error: ' + (data.error || 'Failed to browse directory'));
        }
    } catch (error) {
        alert('Error browsing directory: ' + error.message);
    }
}

function selectCurrentDirectory() {
    document.getElementById('backup_dir').value = currentBrowsePath;
    closeModal();
}

async function createBackup() {
    if (!confirm('Create a new backup of the database?')) {
        return;
    }

    try {
        const response = await fetch('/api/create-backup', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

        const data = await response.json();

        if (response.ok) {
            alert(`Backup created successfully!\n\nFilename: ${data.filename}\nSize: ${data.size}`);
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to create backup'));
        }
    } catch (error) {
        alert('Error creating backup: ' + error.message);
    }
}

async function restoreBackup(filename) {
    if (!confirm(`Are you sure you want to restore this backup?\n\n${filename}\n\nWARNING: This will replace ALL current data!`)) {
        return;
    }

    if (!confirm('This action cannot be undone. Are you absolutely sure?')) {
        return;
    }

    try {
        const response = await fetch('/api/restore-backup', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({filename: filename})
        });

        const data = await response.json();

        if (response.ok) {
            alert('Database restored successfully! You will be logged out now.');
            window.location.href = '/logout';
        } else {
            alert('Error: ' + (data.error || 'Failed to restore backup'));
        }
    } catch (error) {
        alert('Error restoring backup: ' + error.message);
    }
}

function downloadBackup(filename) {
    // Create a download link
    const backupDir = document.getElementById('backup_dir').value;
    window.location.href = `/download-backup/${filename}`;
}

async function deleteBackup(filename) {
    if (!confirm(`Delete backup file?\n\n${filename}`)) {
        return;
    }

    try {
        const response = await fetch('/api/delete-backup', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({filename: filename})
        });

        const data = await response.json();

        if (response.ok) {
            alert('Backup deleted successfully!');
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete backup'));
        }
    } catch (error) {
        alert('Error deleting backup: ' + error.message);
    }
}

async function saveConfiguration() {
    const config = {
        backup_dir: document.getElementById('backup_dir').value,
        schedule: document.getElementById('schedule').value,
        retention_days: parseInt(document.getElementById('retention').value),
        auto_backup_enabled: document.getElementById('auto_backup').checked
    };

    try {
        const response = await fetch('/api/backup-config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });

        const data = await response.json();

        if (response.ok) {
            alert('Configuration saved successfully!');
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to save configuration'));
        }
    } catch (error) {
        alert('Error saving configuration: ' + error.message);
    }
}

// Update status indicator when toggle changes
document.getElementById('auto_backup').addEventListener('change', function() {
    const indicator = this.parentElement.parentElement.querySelector('.status-indicator');
    if (this.checked) {
        indicator.className = 'status-indicator status-enabled';
        indicator.textContent = 'Enabled';
    } else {
        indicator.className = 'status-indicator status-disabled';
        indicator.textContent = 'Disabled';
    }
});

// Close modal when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('active');
    }
}
</script>

{% endblock %}